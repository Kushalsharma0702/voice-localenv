<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Assistant Call Management Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e3e8ee;
        }

        .card h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Enhanced Filter Section */
        .filter-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }

        .filter-input, .filter-select {
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* CSV Data Table Styles */
        .csv-data-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e3e8ee;
        }

        .csv-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .csv-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #5a67d8;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .csv-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }

        .csv-table tr:hover {
            background-color: #f8f9fa;
        }

        .csv-table tr:nth-child(even) {
            background-color: #fafbfc;
        }

        /* Status Badge Styles */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-ready { background: #d4edda; color: #155724; }
        .status-calling { background: #fff3cd; color: #856404; }
        .status-in-progress { background: #cce5ff; color: #004085; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .status-agent-transfer { background: #e2e3e5; color: #383d41; }

        /* Upload Date Badge */
        .upload-date-badge {
            padding: 3px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 500;
        }

        .date-today { background: #e8f5e8; color: #2e7d32; }
        .date-yesterday { background: #fff8e1; color: #f57f17; }
        .date-week { background: #e3f2fd; color: #1565c0; }
        .date-older { background: #fce4ec; color: #c2185b; }
        .date-future { background: #f3e5f5; color: #7b1fa2; }

        /* Action Buttons */
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            margin: 2px;
            transition: all 0.3s ease;
        }

        .btn-call {
            background: #28a745;
            color: white;
        }

        .btn-call:hover {
            background: #218838;
        }

        .btn-status {
            background: #17a2b8;
            color: white;
        }

        .btn-status:hover {
            background: #138496;
        }

        .btn-details {
            background: #6c757d;
            color: white;
        }

        .btn-details:hover {
            background: #5a6268;
        }

        /* Bulk Actions */
        .bulk-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .bulk-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bulk-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .bulk-btn-primary {
            background: #007bff;
            color: white;
        }

        .bulk-btn-success {
            background: #28a745;
            color: white;
        }

        .bulk-btn-warning {
            background: #ffc107;
            color: #212529;
        }

        /* Statistics Grid */
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Upload Section */
        .upload-section {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-section.dragover {
            border-color: #667eea;
            background-color: #f0f4ff;
        }

        .upload-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
        }

        /* Customer Details Modal */
        .customer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        /* Table Container with Scroll */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e3e8ee;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .statistics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .bulk-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .csv-table {
                font-size: 11px;
            }
            
            .csv-table th, .csv-table td {
                padding: 6px 4px;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Progress Bar */
        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 350px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .toast.info {
            background: #17a2b8;
        }

        .toast.warning {
            background: #ffc107;
            color: #212529;
        }

        /* Batch Details Section */
        .batch-details-container {
            margin-top: 20px;
        }

        .batch-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .batch-stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .batch-stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .batch-stat-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        .batch-table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .batch-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .batch-table-header h4 {
            margin: 0;
            color: #333;
        }

        /* Call Status Tracking Styles */
        .call-status-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        .call-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .call-status-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .call-stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid #28a745;
        }

        .call-stat-card:nth-child(2) {
            border-left-color: #ffc107;
        }

        .call-stat-card:nth-child(3) {
            border-left-color: #28a745;
        }

        .call-stat-card:nth-child(4) {
            border-left-color: #dc3545;
        }

        .call-stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .call-stat-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }

        .call-status-actions {
            display: flex;
            gap: 10px;
        }

        .refresh-button, .auto-refresh-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .refresh-button:hover, .auto-refresh-button:hover {
            background: #5a6fd8;
        }

        .auto-refresh-button.active {
            background: #28a745;
        }

        .call-status-table-container {
            overflow-x: auto;
        }

        .call-status-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .call-status-table th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
        }

        .call-status-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .call-status-table tr:hover {
            background-color: #f8f9fa;
        }

        .call-status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-initiated { background: #e3f2fd; color: #1976d2; }
        .status-call_in_progress { background: #fff3e0; color: #f57c00; }
        .status-call_completed { background: #e8f5e8; color: #2e7d32; }
        .status-call_failed { background: #ffebee; color: #c62828; }
        .status-ringing { background: #f3e5f5; color: #7b1fa2; }

        /* Call Details Modal Styles */
        .call-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .call-info p {
            margin: 5px 0;
        }

        .status-timeline {
            max-height: 400px;
            overflow-y: auto;
        }

        .status-timeline-item {
            display: flex;
            gap: 15px;
            padding: 10px;
            border-left: 3px solid #e9ecef;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .status-timestamp {
            flex-shrink: 0;
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
            width: 120px;
        }

        .status-info {
            flex-grow: 1;
        }

        .status-message {
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
        }

        .call-actions {
            display: flex;
            gap: 5px;
        }

        .call-action-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s;
        }

        .call-action-btn:hover {
            background: #5a6fd8;
        }

        .refresh-batch-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .refresh-batch-btn:hover {
            background: #5a6fd8;
        }

        .batch-table-wrapper {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .batch-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .batch-table th {
            background: #667eea;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .batch-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }

        .batch-table tbody tr:hover {
            background: #f8f9fa;
        }

        .loading-row {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .batch-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            text-transform: uppercase;
        }

        .batch-status.completed {
            background: #d4edda;
            color: #155724;
        }

        .batch-status.processing {
            background: #fff3cd;
            color: #856404;
        }

        .batch-status.failed {
            background: #f8d7da;
            color: #721c24;
        }

        .batch-status.pending {
            background: #d1ecf1;
            color: #0c5460;
        }

        .batch-success-rate {
            font-weight: 600;
        }

        .batch-success-rate.high {
            color: #28a745;
        }

        .batch-success-rate.medium {
            color: #ffc107;
        }

        .batch-success-rate.low {
            color: #dc3545;
        }

        .batch-actions {
            display: flex;
            gap: 5px;
        }

        .batch-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: opacity 0.3s ease;
        }

        .batch-action-btn:hover {
            opacity: 0.8;
        }

        .batch-action-btn.view {
            background: #17a2b8;
            color: white;
        }

        .batch-action-btn.download {
            background: #28a745;
            color: white;
        }

        .batch-action-btn.delete {
            background: #dc3545;
            color: white;
        }

        /* Responsive design for batch section */
        @media (max-width: 768px) {
            .batch-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .batch-table-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .batch-table {
                font-size: 0.8em;
            }
            
            .batch-table th,
            .batch-table td {
                padding: 8px 10px;
            }
        }
    </style>
</head>

        </style>
    </head>
    <body>

    <div class="header">
        <h1>🎙️ Voice Assistant Call Management Dashboard</h1>
        <p>Enhanced Customer Data Management with CSV Format Display</p>
        <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
            <span id="lastStatusUpdate">Last update: Never</span> | 
            <span id="statusRefreshCount">Refreshes: 0</span> |
            <span id="totalCustomersDisplay">Total: 0</span>
        </div>
    </div>

    <div class="connection-status" id="connectionStatus">Connecting...</div>

    <div class="container">
        <!-- Statistics Overview -->
        <div class="statistics-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCustomersStat">0</div>
                <div class="stat-label">Total Customers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayUploadsStat">0</div>
                <div class="stat-label">Today's Uploads</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="readyToCallStat">0</div>
                <div class="stat-label">Ready to Call</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeCallsStat">0</div>
                <div class="stat-label">Active Calls</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedCallsStat">0</div>
                <div class="stat-label">Completed Today</div>
            </div>
        </div>

        <!-- Quick Upload Section -->
        <div class="card">
            <h3>� CSV File Upload</h3>
            <div class="upload-section" id="uploadArea">
                <p>📄 Drag & drop CSV file here or click to browse</p>
                <p style="font-size: 0.9em; color: #666; margin: 10px 0;">
                    Expected format: name, phone, loan_id, amount, due_date, state, Cluster, Branch, etc.
                </p>
                <input type="file" id="fileInput" accept=".csv" style="display: none;">
                <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                    Choose CSV File
                </button>
            </div>
            <div id="uploadStatus" class="log-entry"></div>
            <div id="uploadProgress" class="progress-container" style="display: none;">
                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
            </div>
        </div>

        <!-- Batch Upload Details Section -->
        <div class="card">
            <h3>📊 Batch Upload Details</h3>
            <div class="batch-details-container">
                <div class="batch-stats-grid">
                    <div class="batch-stat-card">
                        <div class="batch-stat-number" id="totalBatchesStat">0</div>
                        <div class="batch-stat-label">Total Batches</div>
                    </div>
                    <div class="batch-stat-card">
                        <div class="batch-stat-number" id="todayBatchesStat">0</div>
                        <div class="batch-stat-label">Today's Batches</div>
                    </div>
                    <div class="batch-stat-card">
                        <div class="batch-stat-number" id="totalRecordsStat">0</div>
                        <div class="batch-stat-label">Total Records</div>
                    </div>
                    <div class="batch-stat-card">
                        <div class="batch-stat-number" id="successRateStat">0%</div>
                        <div class="batch-stat-label">Success Rate</div>
                    </div>
                </div>
                <div class="batch-table-container">
                    <div class="batch-table-header">
                        <h4>📄 Recent File Uploads</h4>
                        <button class="refresh-batch-btn" onclick="loadBatchDetails()">🔄 Refresh</button>
                    </div>
                    <div class="batch-table-wrapper">
                        <table class="batch-table" id="batchTable">
                            <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Upload Date</th>
                                    <th>Total Records</th>
                                    <th>Success Rate</th>
                                    <th>Status</th>
                                    <th>Uploaded By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="batchTableBody">
                                <tr>
                                    <td colspan="7" class="loading-row">Loading batch data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Call Status Tracking Section
        <div class="card">
            <h3>📞 Call Status Tracking</h3>
            <div class="call-status-container">
                <div class="call-status-header">
                    <div class="call-status-stats">
                        <div class="call-stat-card">
                            <div class="call-stat-number" id="totalCallsStat">0</div>
                            <div class="call-stat-label">Total Calls</div>
                        </div>
                        <div class="call-stat-card">
                            <div class="call-stat-number" id="inProgressCallsStat">0</div>
                            <div class="call-stat-label">In Progress</div>
                        </div>
                        <div class="call-stat-card">
                            <div class="call-stat-number" id="completedCallsStat">0</div>
                            <div class="call-stat-label">Completed</div>
                        </div>
                        <div class="call-stat-card">
                            <div class="call-stat-number" id="failedCallsStat">0</div>
                            <div class="call-stat-label">Failed</div>
                        </div>
                    </div>
                    <div class="call-status-actions">
                        <button class="refresh-button" onclick="loadCallStatuses()">🔄 Refresh</button>
                        <button class="auto-refresh-button" onclick="toggleAutoRefresh()">
                            <span id="autoRefreshText">▶️ Auto Refresh</span>
                        </button>
                    </div>
                </div>
                
                <div class="call-status-table-container">
                    <table class="call-status-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Call SID</th>
                                <th>Status</th>
                                <th>Message</th>
                                <th>Timestamp</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="callStatusTableBody">
                            <tr>
                                <td colspan="7" class="loading-row">Loading call status data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div> -->

        <!-- Enhanced Filter Section -->
        <div class="card">
            <h3>🔍 Advanced Filters & Search</h3>
            <div class="filter-section">
                <div class="filter-grid">
                    <div class="filter-group">
                        <label class="filter-label">🔍 Search</label>
                        <input type="text" class="filter-input" id="searchInput" 
                               placeholder="Search by name, phone, loan ID...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">📅 Upload Date</label>
                        <select class="filter-select" id="uploadDateFilter">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="this-week">This Week</option>
                            <option value="last-week">Last Week</option>
                            <option value="this-month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="filter-group" id="customDateRange" style="display: none;">
                        <label class="filter-label">📅 Date Range</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="date" class="filter-input" id="startDate">
                            <input type="date" class="filter-input" id="endDate">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">� Call Status</label>
                        <select class="filter-select" id="callStatusFilter">
                            <option value="">All Statuses</option>
                            <option value="ready">Ready</option>
                            <option value="calling">Calling</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="agent-transfer">Agent Transfer</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">🌍 State</label>
                        <select class="filter-select" id="stateFilter">
                            <option value="">All States</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">🏢 Cluster</label>
                        <select class="filter-select" id="clusterFilter">
                            <option value="">All Clusters</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">🏪 Branch</label>
                        <select class="filter-select" id="branchFilter">
                            <option value="">All Branches</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">👤 Employee</label>
                        <select class="filter-select" id="employeeFilter">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                </div>
                
                <div class="bulk-actions">
                    <span class="selected-count" id="selectedCount">0 selected</span>
                    <button class="bulk-btn bulk-btn-primary" id="refreshDataBtn">
                        🔄 Refresh Data
                    </button>
                    <button class="bulk-btn bulk-btn-success" id="callSelectedBtn" disabled>
                        📞 Call Selected (<span id="selectedCountText">0</span>)
                    </button>
                    <button class="bulk-btn bulk-btn-warning" id="updateSelectedStatusBtn" disabled>
                        📊 Update Status
                    </button>
                    <button class="bulk-btn" id="exportSelectedBtn" disabled>
                        📥 Export Selected
                    </button>
                    <button class="bulk-btn" id="clearFiltersBtn">
                        🗑️ Clear Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Customer Data Table in CSV Format -->
        <div class="card">
            <h3>👥 Customer Data (Live Database Feed)</h3>
            <div style="margin-bottom: 15px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #28a745;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="color: #28a745; font-weight: 600;">🟢 Live Database Connection</span>
                    <span style="font-size: 0.9em; color: #666;">
                        Data automatically synced from PostgreSQL database every 5 minutes
                    </span>
                    <button class="bulk-btn bulk-btn-primary" onclick="loadCustomerData(true)" style="margin-left: auto; padding: 4px 8px; font-size: 0.8em;">
                        🔄 Refresh Now
                    </button>
                </div>
            </div>
            <div class="csv-data-container">
                <div class="table-container">
                    <table class="csv-table" id="customerTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th>Upload Date</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Loan ID</th>
                                <th>Amount</th>
                                <th>Due Date</th>
                                <th>State</th>
                                <th>Cluster</th>
                                <th>Branch</th>
                                <th>Branch Contact</th>
                                <th>Employee</th>
                                <th>Employee ID</th>
                                <th>Employee Contact</th>
                                <th>Last Paid Date</th>
                                <th>Last Paid Amount</th>
                                <th>Due Amount</th>
                                <th>Call Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody">
                            <tr>
                                <td colspan="19" style="text-align: center; padding: 40px; color: #666;">
                                    <div class="loading"></div>
                                    <div style="margin-top: 10px;">Loading customer data...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div>
                    <label>Show: </label>
                    <select id="recordsPerPage" class="filter-select" style="width: auto; margin: 0 10px;">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="250">250</option>
                        <option value="all">All</option>
                    </select>
                    <span>records per page</span>
                </div>
                <div id="paginationInfo">
                    Showing 0-0 of 0 records
                </div>
                <div id="paginationControls">
                    <button class="bulk-btn" id="prevPageBtn" disabled>← Previous</button>
                    <span id="currentPageInfo">Page 1 of 1</span>
                    <button class="bulk-btn" id="nextPageBtn" disabled>Next →</button>
                </div>
            </div>
        </div>

        <!-- Real-time Call Status -->
        <div class="card">
            <h3>🔄 Real-time Call Status & Activity Log</h3>
            <div id="callStatusContainer">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card" style="border-left-color: #28a745;">
                        <div class="stat-number" id="activeCallsCount">0</div>
                        <div class="stat-label">Active Calls</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #ffc107;">
                        <div class="stat-number" id="queuedCallsCount">0</div>
                        <div class="stat-label">Queued Calls</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #17a2b8;">
                        <div class="stat-number" id="completedTodayCount">0</div>
                        <div class="stat-label">Completed Today</div>
                    </div>
                </div>
                <div id="activityLog" style="background: #f8f9fa; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    <div style="color: #666; text-align: center; padding: 20px;">
                        No recent activity
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Details Modal -->
    <div class="customer-modal" id="customerModal">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <h3>👤 Customer Details</h3>
            <div id="customerDetailsContent">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let customers = [];
        let filteredCustomers = [];
        let selectedCustomers = new Set();
        let currentPage = 1;
        let recordsPerPage = 25;
        let ws = null;
        let refreshInterval = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            initializeEventListeners();
            loadCustomerData();
            loadBatchDetails();
            loadCallStatuses();
            setupAutoRefresh();
        });

        // WebSocket connection
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/dashboard/enhanced`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                updateConnectionStatus('connected');
                logActivity('WebSocket connected successfully');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                updateConnectionStatus('disconnected');
                logActivity('WebSocket disconnected, attempting to reconnect...');
                setTimeout(initializeWebSocket, 3000);
            };
            
            ws.onerror = function() {
                updateConnectionStatus('error');
                logActivity('WebSocket connection error');
            };
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            switch(data.event) {
                case 'call_status_update':
                    updateCustomerCallStatus(data.customer_id, data.status, data.message);
                    break;
                case 'upload_progress':
                    updateUploadProgress(data.progress, data.message);
                    break;
                case 'upload_complete':
                    // Refresh customer data when upload completes
                    logActivity('📊 Upload completed, refreshing customer data...');
                    setTimeout(() => loadCustomerData(true), 1000);
                    break;
                case 'bulk_operation_update':
                    updateBulkOperationStatus(data);
                    break;
                case 'data_update':
                    // Generic data update event
                    logActivity('📊 Data updated, refreshing customer list...');
                    loadCustomerData(false);
                    break;
                default:
                    console.log('Unknown WebSocket event:', data);
            }
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // File upload
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            
            fileInput.addEventListener('change', handleFileUpload);
            
            // Drag and drop
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload();
                }
            });

            // Filter controls
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('uploadDateFilter').addEventListener('change', handleDateFilterChange);
            document.getElementById('callStatusFilter').addEventListener('change', applyFilters);
            document.getElementById('stateFilter').addEventListener('change', applyFilters);
            document.getElementById('clusterFilter').addEventListener('change', applyFilters);
            document.getElementById('branchFilter').addEventListener('change', applyFilters);
            document.getElementById('employeeFilter').addEventListener('change', applyFilters);
            document.getElementById('startDate').addEventListener('change', applyFilters);
            document.getElementById('endDate').addEventListener('change', applyFilters);

            // Bulk action buttons
            document.getElementById('refreshDataBtn').addEventListener('click', () => loadCustomerData(true));
            document.getElementById('callSelectedBtn').addEventListener('click', callSelectedCustomers);
            document.getElementById('updateSelectedStatusBtn').addEventListener('click', updateSelectedStatus);
            document.getElementById('exportSelectedBtn').addEventListener('click', exportSelectedCustomers);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);

            // Pagination
            document.getElementById('recordsPerPage').addEventListener('change', function() {
                recordsPerPage = this.value === 'all' ? filteredCustomers.length : parseInt(this.value);
                currentPage = 1;
                renderCustomerTable();
            });
            
            document.getElementById('prevPageBtn').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    renderCustomerTable();
                }
            });
            
            document.getElementById('nextPageBtn').addEventListener('click', function() {
                const totalPages = Math.ceil(filteredCustomers.length / recordsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderCustomerTable();
                }
            });

            // Select all checkbox
            document.getElementById('selectAll').addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('#customerTableBody input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    if (this.checked) {
                        selectedCustomers.add(cb.value);
                    } else {
                        selectedCustomers.delete(cb.value);
                    }
                });
                updateSelectionCount();
            });

            // Modal close
            document.getElementById('modalClose').addEventListener('click', function() {
                document.getElementById('customerModal').style.display = 'none';
            });
        }

        // Handle date filter changes
        function handleDateFilterChange() {
            const dateFilter = document.getElementById('uploadDateFilter').value;
            const customDateRange = document.getElementById('customDateRange');
            
            if (dateFilter === 'custom') {
                customDateRange.style.display = 'block';
            } else {
                customDateRange.style.display = 'none';
            }
            
            applyFilters();
        }

        // Load customer data from database with enhanced error handling
        async function loadCustomerData(forceRefresh = false) {
            try {
                showLoading(true);
                
                if (forceRefresh) {
                    logActivity('🔄 Force refreshing customer data from database...');
                } else {
                    logActivity('📊 Loading customer data from database...');
                }
                
                // Add cache-busting parameter to ensure fresh data
                const cacheBuster = `?_t=${Date.now()}`;
                const response = await fetch(`/api/customers${cacheBuster}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch customers: ${response.status} ${response.statusText}`);
                }
                
                const responseData = await response.json();
                
                // Ensure we have an array of customers
                if (!Array.isArray(responseData)) {
                    throw new Error('Invalid response format: expected array of customers');
                }
                
                customers = responseData;
                filteredCustomers = [...customers];
                
                // Clear any existing selections since data has been refreshed
                selectedCustomers.clear();
                updateSelectionCount();
                
                populateFilterOptions();
                applyFilters();
                updateStatistics();
                
                const timestamp = getCurrentISTTime();
                logActivity(`✅ Successfully loaded ${customers.length} customers from database at ${timestamp} IST`);
                
                // Show success toast for manual refreshes
                if (forceRefresh) {
                    showToast(`Data refreshed: ${customers.length} customers loaded`, 'success');
                }
                
                // Update last refresh time in header
                document.getElementById('lastStatusUpdate').textContent = `Last update: ${timestamp} IST`;
                
            } catch (error) {
                console.error('Error loading customers:', error);
                const errorMessage = `Failed to load customer data: ${error.message}`;
                logActivity(`❌ ${errorMessage}`, 'error');
                showToast(errorMessage, 'error');
                
                // Show error in table if no data is available
                if (customers.length === 0) {
                    const tbody = document.getElementById('customerTableBody');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="19" style="text-align: center; padding: 40px; color: #dc3545;">
                                <div style="margin-bottom: 10px;">⚠️ Error loading customer data</div>
                                <div style="font-size: 0.9em;">${error.message}</div>
                                <button class="bulk-btn bulk-btn-primary" onclick="loadCustomerData(true)" style="margin-top: 15px;">
                                    🔄 Retry
                                </button>
                            </td>
                        </tr>
                    `;
                }
            } finally {
                showLoading(false);
            }
        }

        // Load batch details from database
        async function loadBatchDetails() {
            try {
                logActivity('📊 Loading batch upload details...');
                
                const response = await fetch('/api/uploaded-files', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch batch data: ${response.status} ${response.statusText}`);
                }
                
                const responseData = await response.json();
                
                if (!responseData.success) {
                    throw new Error(responseData.error || 'Failed to load batch data');
                }
                
                const batches = responseData.uploads || [];
                
                // Update batch statistics
                updateBatchStatistics(batches);
                
                // Populate batch table
                populateBatchTable(batches);
                
                logActivity(`✅ Successfully loaded ${batches.length} batch uploads`);
                
            } catch (error) {
                console.error('Error loading batch details:', error);
                logActivity(`❌ Failed to load batch details: ${error.message}`, 'error');
                
                // Show error in batch table
                const tbody = document.getElementById('batchTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #dc3545;">
                            <div>⚠️ Error loading batch data: ${error.message}</div>
                            <button class="refresh-batch-btn" onclick="loadBatchDetails()" style="margin-top: 10px;">
                                🔄 Retry
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        // Update batch statistics
        function updateBatchStatistics(batches) {
            const today = new Date().toDateString();
            
            // Calculate statistics
            const totalBatches = batches.length;
            const todayBatches = batches.filter(batch => {
                const batchDate = new Date(batch.uploaded_at).toDateString();
                return batchDate === today;
            }).length;
            
            const totalRecords = batches.reduce((sum, batch) => sum + (batch.total_records || 0), 0);
            const totalSuccess = batches.reduce((sum, batch) => sum + (batch.success_records || 0), 0);
            const successRate = totalRecords > 0 ? Math.round((totalSuccess / totalRecords) * 100) : 0;
            
            // Update DOM elements
            document.getElementById('totalBatchesStat').textContent = totalBatches;
            document.getElementById('todayBatchesStat').textContent = todayBatches;
            document.getElementById('totalRecordsStat').textContent = totalRecords.toLocaleString();
            document.getElementById('successRateStat').textContent = `${successRate}%`;
        }

        // Populate batch table
        function populateBatchTable(batches) {
            const tbody = document.getElementById('batchTableBody');
            
            if (batches.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                            📄 No batch uploads found
                        </td>
                    </tr>
                `;
                return;
            }
            
            const batchRows = batches.map(batch => {
                const uploadDate = new Date(batch.uploaded_at);
                const formattedDate = uploadDate.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const successRate = batch.total_records > 0 
                    ? Math.round((batch.success_records / batch.total_records) * 100)
                    : 0;
                
                const successRateClass = successRate >= 90 ? 'high' : 
                                       successRate >= 70 ? 'medium' : 'low';
                
                const statusClass = batch.status.toLowerCase().replace(' ', '-');
                
                return `
                    <tr>
                        <td title="${batch.original_filename || batch.filename}">
                            ${truncateText(batch.original_filename || batch.filename, 25)}
                        </td>
                        <td>${formattedDate}</td>
                        <td>${batch.total_records.toLocaleString()}</td>
                        <td>
                            <span class="batch-success-rate ${successRateClass}">
                                ${successRate}% (${batch.success_records}/${batch.total_records})
                            </span>
                        </td>
                        <td>
                            <span class="batch-status ${statusClass}">
                                ${batch.status}
                            </span>
                        </td>
                        <td>${batch.uploaded_by || 'System'}</td>
                        <td>
                            <div class="batch-actions">
                                <button class="batch-action-btn view" onclick="viewBatchDetails('${batch.id}')" title="View Details">
                                    👁️
                                </button>
                                <button class="batch-action-btn download" onclick="downloadBatchReport('${batch.id}')" title="Download Report">
                                    💾
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = batchRows;
        }

        // View batch details in modal
        async function viewBatchDetails(batchId) {
            try {
                const response = await fetch(`/api/uploaded-files/${batchId}/details`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch batch details: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load batch details');
                }
                
                // Create and show modal with batch details
                showBatchDetailsModal(data.upload_details, data.upload_details.rows);
                
            } catch (error) {
                console.error('Error viewing batch details:', error);
                showToast(`Failed to load batch details: ${error.message}`, 'error');
            }
        }

        // Show batch details modal
        function showBatchDetailsModal(upload, rows) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="modal-close" onclick="closeModal(this)">&times;</span>
                    <h3>📄 Batch Upload Details</h3>
                    <div class="batch-detail-info">
                        <div><strong>File:</strong> ${upload.original_filename || upload.filename}</div>
                        <div><strong>Uploaded:</strong> ${new Date(upload.uploaded_at).toLocaleString('en-IN')}</div>
                        <div><strong>Status:</strong> <span class="batch-status ${upload.status.toLowerCase()}">${upload.status}</span></div>
                        <div><strong>Total Records:</strong> ${upload.total_records}</div>
                        <div><strong>Success:</strong> ${upload.success_records}</div>
                        <div><strong>Failed:</strong> ${upload.failed_records}</div>
                        ${upload.processing_errors ? `<div><strong>Errors:</strong> <pre>${JSON.stringify(upload.processing_errors, null, 2)}</pre></div>` : ''}
                    </div>
                    ${rows && rows.length > 0 ? `
                        <h4>Sample Records (First 10)</h4>
                        <div class="table-container">
                            <table class="csv-table">
                                <thead>
                                    <tr>
                                        <th>Row #</th>
                                        <th>Customer Name</th>
                                        <th>Phone</th>
                                        <th>Loan ID</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rows.slice(0, 10).map((row, index) => `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>${row.customer_name || 'N/A'}</td>
                                            <td>${row.phone || 'N/A'}</td>
                                            <td>${row.loan_id || 'N/A'}</td>
                                            <td><span class="batch-status ${(row.processing_status || 'unknown').toLowerCase()}">${row.processing_status || 'Unknown'}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        // Download batch report
        function downloadBatchReport(batchId) {
            // Create downloadable CSV report
            const link = document.createElement('a');
            link.href = `/api/uploaded-files/${batchId}/download`;
            link.download = `batch_report_${batchId}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Batch report download started', 'info');
        }

        // Close modal
        function closeModal(element) {
            const modal = element.closest('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // Utility function to truncate text
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength - 3) + '...';
        }

        // === CALL STATUS TRACKING FUNCTIONS ===
        
        let autoRefreshInterval = null;
        let isAutoRefresh = false;

        // Load call statuses from the API
        async function loadCallStatuses() {
            try {
                logActivity('📞 Loading call status data...');
                
                const response = await fetch('/api/call-statuses');
                if (!response.ok) {
                    throw new Error(`Failed to fetch call statuses: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load call statuses');
                }
                
                updateCallStatusStats(data.statuses);
                populateCallStatusTable(data.statuses);
                
                logActivity(`✅ Loaded ${data.statuses.length} call status updates`);
                
            } catch (error) {
                console.error('Error loading call statuses:', error);
                logActivity(`❌ Failed to load call statuses: ${error.message}`);
                showToast(`Failed to load call statuses: ${error.message}`, 'error');
            }
        }

        // Update call status statistics
        function updateCallStatusStats(statuses) {
            // Group statuses by latest status per call
            const callStatusMap = new Map();
            
            statuses.forEach(status => {
                const existing = callStatusMap.get(status.call_sid);
                if (!existing || new Date(status.timestamp) > new Date(existing.timestamp)) {
                    callStatusMap.set(status.call_sid, status);
                }
            });
            
            const latestStatuses = Array.from(callStatusMap.values());
            
            // Calculate statistics
            const totalCalls = latestStatuses.length;
            const inProgressCalls = latestStatuses.filter(s => 
                s.status === 'call_in_progress' || s.status === 'ringing' || s.status === 'initiated'
            ).length;
            const completedCalls = latestStatuses.filter(s => s.status === 'call_completed').length;
            const failedCalls = latestStatuses.filter(s => s.status === 'call_failed').length;
            
            // Update DOM elements
            document.getElementById('totalCallsStat').textContent = totalCalls;
            document.getElementById('inProgressCallsStat').textContent = inProgressCalls;
            document.getElementById('completedCallsStat').textContent = completedCalls;
            document.getElementById('failedCallsStat').textContent = failedCalls;
        }

        // Populate call status table
        function populateCallStatusTable(statuses) {
            const tbody = document.getElementById('callStatusTableBody');
            
            if (statuses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #666;">
                            📞 No call status updates found
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by timestamp descending (newest first)
            const sortedStatuses = statuses.sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            const statusRows = sortedStatuses.slice(0, 50).map(status => {
                const timestamp = new Date(status.timestamp);
                const formattedTime = timestamp.toLocaleString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const statusClass = status.status.toLowerCase().replace(/_/g, '_');
                
                return `
                    <tr>
                        <td title="${status.customer_name}">
                            ${truncateText(status.customer_name, 20)}
                        </td>
                        <td>${status.customer_phone}</td>
                        <td title="${status.call_sid}">
                            ${truncateText(status.call_sid, 15)}
                        </td>
                        <td>
                            <span class="call-status-badge status-${statusClass}">
                                ${status.status.replace(/_/g, ' ')}
                            </span>
                        </td>
                        <td title="${status.message || 'No message'}">
                            ${truncateText(status.message || 'No message', 30)}
                        </td>
                        <td>${formattedTime}</td>
                        <td>
                            <div class="call-actions">
                                <button class="call-action-btn view" onclick="viewCallDetails('${status.call_sid}')" title="View All Updates">
                                    👁️
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = statusRows;
        }

        // View call details
        async function viewCallDetails(callSid) {
            try {
                const response = await fetch(`/api/call-statuses/${callSid}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch call details: ${response.status}`);
                }
                
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load call details');
                }
                
                showCallDetailsModal(data);
                
            } catch (error) {
                console.error('Error viewing call details:', error);
                showToast(`Failed to load call details: ${error.message}`, 'error');
            }
        }

        // Show call details modal
        function showCallDetailsModal(callData) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>📞 Call Details - ${callData.call_sid}</h3>
                        <button class="modal-close" onclick="closeModal(this)">✖️</button>
                    </div>
                    <div class="modal-body">
                        <div class="call-info">
                            <p><strong>Customer:</strong> ${callData.customer_name || 'Unknown'}</p>
                            <p><strong>Phone:</strong> ${callData.customer_phone || 'Unknown'}</p>
                            <p><strong>Call SID:</strong> ${callData.call_sid}</p>
                        </div>
                        <h4>Status Updates:</h4>
                        <div class="status-timeline">
                            ${callData.statuses.map(status => {
                                const timestamp = new Date(status.timestamp);
                                const formattedTime = timestamp.toLocaleString('en-IN');
                                const statusClass = status.status.toLowerCase().replace(/_/g, '_');
                                
                                return `
                                    <div class="status-timeline-item">
                                        <div class="status-timestamp">${formattedTime}</div>
                                        <div class="status-info">
                                            <span class="call-status-badge status-${statusClass}">
                                                ${status.status.replace(/_/g, ' ')}
                                            </span>
                                            <div class="status-message">${status.message || 'No message'}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        // Toggle auto refresh
        function toggleAutoRefresh() {
            const button = document.querySelector('.auto-refresh-button');
            const text = document.getElementById('autoRefreshText');
            
            if (isAutoRefresh) {
                // Stop auto refresh
                clearInterval(autoRefreshInterval);
                isAutoRefresh = false;
                button.classList.remove('active');
                text.textContent = '▶️ Auto Refresh';
                logActivity('⏸️ Auto refresh stopped');
            } else {
                // Start auto refresh
                autoRefreshInterval = setInterval(loadCallStatuses, 10000); // Every 10 seconds
                isAutoRefresh = true;
                button.classList.add('active');
                text.textContent = '⏸️ Stop Auto';
                logActivity('▶️ Auto refresh started (10s interval)');
            }
        }

        // Populate filter dropdown options
        function populateFilterOptions() {
            const states = [...new Set(customers.map(c => c.state).filter(Boolean))].sort();
            const clusters = [...new Set(customers.flatMap(c => c.loans.map(l => l.cluster).filter(Boolean)))].sort();
            const branches = [...new Set(customers.flatMap(c => c.loans.map(l => l.branch).filter(Boolean)))].sort();
            const employees = [...new Set(customers.flatMap(c => c.loans.map(l => l.employee_name).filter(Boolean)))].sort();

            populateSelect('stateFilter', states);
            populateSelect('clusterFilter', clusters);
            populateSelect('branchFilter', branches);
            populateSelect('employeeFilter', employees);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Keep the "All" option and add new options
            select.innerHTML = select.children[0].outerHTML;
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            // Restore selection if it still exists
            if (options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const uploadDateFilter = document.getElementById('uploadDateFilter').value;
            const callStatusFilter = document.getElementById('callStatusFilter').value;
            const stateFilter = document.getElementById('stateFilter').value;
            const clusterFilter = document.getElementById('clusterFilter').value;
            const branchFilter = document.getElementById('branchFilter').value;
            const employeeFilter = document.getElementById('employeeFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            filteredCustomers = customers.filter(customer => {
                // Search filter
                if (searchTerm) {
                    const searchMatch = 
                        customer.full_name.toLowerCase().includes(searchTerm) ||
                        customer.primary_phone.includes(searchTerm) ||
                        customer.loans.some(loan => loan.loan_id.toLowerCase().includes(searchTerm));
                    if (!searchMatch) return false;
                }

                // Upload date filter
                if (uploadDateFilter && uploadDateFilter !== 'custom') {
                    if (!matchesDateFilter(customer.first_uploaded_at, uploadDateFilter)) return false;
                }

                // Custom date range filter
                if (uploadDateFilter === 'custom' && (startDate || endDate)) {
                    const uploadDate = new Date(customer.first_uploaded_at).toISOString().split('T')[0];
                    if (startDate && uploadDate < startDate) return false;
                    if (endDate && uploadDate > endDate) return false;
                }

                // Call status filter
                if (callStatusFilter) {
                    // Map status values
                    const customerStatus = mapCallStatus(customer.call_status || 'ready');
                    if (customerStatus !== callStatusFilter) return false;
                }

                // State filter
                if (stateFilter && customer.state !== stateFilter) return false;

                // Cluster/Branch/Employee filters (check loans)
                if (clusterFilter || branchFilter || employeeFilter) {
                    const hasMatchingLoan = customer.loans.some(loan => {
                        if (clusterFilter && loan.cluster !== clusterFilter) return false;
                        if (branchFilter && loan.branch !== branchFilter) return false;
                        if (employeeFilter && loan.employee_name !== employeeFilter) return false;
                        return true;
                    });
                    if (!hasMatchingLoan) return false;
                }

                return true;
            });

            currentPage = 1;
            renderCustomerTable();
            updateStatistics();
        }

        // Date filter matching with IST timezone support
        function matchesDateFilter(dateString, filter) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // Convert to IST for accurate date comparison
            const istDate = new Date(date.toLocaleString('en-US', {timeZone: 'Asia/Kolkata'}));
            const istToday = new Date(today.toLocaleString('en-US', {timeZone: 'Asia/Kolkata'}));
            const istYesterday = new Date(yesterday.toLocaleString('en-US', {timeZone: 'Asia/Kolkata'}));

            switch (filter) {
                case 'today':
                    return istDate.toDateString() === istToday.toDateString();
                case 'yesterday':
                    return istDate.toDateString() === istYesterday.toDateString();
                case 'this-week':
                    const weekStart = new Date(istToday);
                    weekStart.setDate(istToday.getDate() - istToday.getDay());
                    return istDate >= weekStart;
                case 'last-week':
                    const lastWeekStart = new Date(istToday);
                    lastWeekStart.setDate(istToday.getDate() - istToday.getDay() - 7);
                    const lastWeekEnd = new Date(lastWeekStart);
                    lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
                    return istDate >= lastWeekStart && istDate <= lastWeekEnd;
                case 'this-month':
                    return istDate.getMonth() === istToday.getMonth() && istDate.getFullYear() === istToday.getFullYear();
                default:
                    return true;
            }
        }

        // Map call status for display
        function mapCallStatus(status) {
            const statusMap = {
                'ready': 'ready',
                'not_initiated': 'ready',
                'calling': 'calling',
                'initiated': 'calling',
                'ringing': 'calling',
                'call_in_progress': 'in-progress',
                'in_progress': 'in-progress',
                'call_completed': 'completed',
                'completed': 'completed',
                'call_failed': 'failed',
                'failed': 'failed',
                'agent_transfer': 'agent-transfer',
                'disconnected': 'failed'
            };
            return statusMap[status] || 'ready';
        }

        // Render customer table
        function renderCustomerTable() {
            const tbody = document.getElementById('customerTableBody');
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = recordsPerPage === 'all' ? filteredCustomers.length : startIndex + recordsPerPage;
            const pageCustomers = filteredCustomers.slice(startIndex, endIndex);

            if (pageCustomers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="19" style="text-align: center; padding: 40px; color: #666;">
                            ${filteredCustomers.length === 0 ? 'No customers found' : 'No customers match the current filters'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = pageCustomers.map(customer => {
                const loan = customer.loans[0] || {};
                const uploadDate = getUploadDateBadge(customer.first_uploaded_at);
                const callStatus = mapCallStatus(customer.call_status || 'ready');
                
                return `
                    <tr class="customer-row ${callStatus}" data-customer-id="${customer.id}">
                        <td>
                            <input type="checkbox" value="${customer.id}" 
                                   ${selectedCustomers.has(customer.id) ? 'checked' : ''}
                                   onchange="toggleCustomerSelection('${customer.id}')">
                        </td>
                        <td>
                            <span class="upload-date-badge ${uploadDate.class}">${uploadDate.text}</span>
                            <div style="font-size: 0.8em; color: #666; margin-top: 2px;">
                                ${formatDate(customer.first_uploaded_at)}
                            </div>
                        </td>
                        <td><strong>${customer.full_name}</strong></td>
                        <td>${customer.primary_phone}</td>
                        <td><code>${loan.loan_id || 'N/A'}</code></td>
                        <td>₹${formatCurrency(loan.outstanding_amount || 0)}</td>
                        <td>${formatDate(loan.next_due_date) || 'N/A'}</td>
                        <td><span class="badge">${customer.state || 'N/A'}</span></td>
                        <td>${loan.cluster || 'N/A'}</td>
                        <td>${loan.branch || 'N/A'}</td>
                        <td>${loan.branch_contact_number || 'N/A'}</td>
                        <td>${loan.employee_name || 'N/A'}</td>
                        <td>${loan.employee_id || 'N/A'}</td>
                        <td>${loan.employee_contact_number || 'N/A'}</td>
                        <td>${formatDate(loan.last_paid_date) || 'N/A'}</td>
                        <td>₹${formatCurrency(loan.last_paid_amount || 0)}</td>
                        <td>₹${formatCurrency(loan.due_amount || 0)}</td>
                        <td>
                            <span class="status-badge status-${callStatus}">
                                ${callStatus.replace('-', ' ')}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn btn-call" onclick="callCustomer('${customer.id}')">
                                📞 Call
                            </button>
                            <button class="action-btn btn-details" onclick="showCustomerDetails('${customer.id}')">
                                👁️ Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            updatePaginationInfo();
        }

        // Get upload date badge with IST timezone support
        function getUploadDateBadge(dateString) {
            if (!dateString) return { class: 'date-older', text: 'Unknown' };
            
            const date = new Date(dateString);
            
            // Get current date in IST
            const now = new Date();
            const istNow = new Date(now.toLocaleString('en-US', {timeZone: 'Asia/Kolkata'}));
            
            // Convert upload date to IST
            const istDate = new Date(date.toLocaleString('en-US', {timeZone: 'Asia/Kolkata'}));
            
            // Get only the date part (ignore time)
            const todayDateString = istNow.toDateString();
            const uploadDateString = istDate.toDateString();
            
            // Compare dates
            if (uploadDateString === todayDateString) {
                return { class: 'date-today', text: 'Today' };
            }
            
            // Check for yesterday
            const yesterday = new Date(istNow);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayDateString = yesterday.toDateString();
            
            if (uploadDateString === yesterdayDateString) {
                return { class: 'date-yesterday', text: 'Yesterday' };
            }
            
            // Calculate days difference more accurately
            const timeDiff = istNow.setHours(0,0,0,0) - istDate.setHours(0,0,0,0);
            const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            if (daysDiff <= 7 && daysDiff > 0) {
                return { class: 'date-week', text: `${daysDiff}d ago` };
            } else if (daysDiff < 0) {
                // Future date
                return { class: 'date-future', text: 'Future' };
            }
            
            return { class: 'date-older', text: `${daysDiff}d ago` };
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN').format(amount);
        }

        // Format date with IST timezone
        function formatDate(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                timeZone: 'Asia/Kolkata',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Format date and time with IST timezone
        function formatDateTime(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString);
            return date.toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                day: '2-digit',
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        // Get IST current time
        function getCurrentISTTime() {
            return new Date().toLocaleString('en-IN', {
                timeZone: 'Asia/Kolkata',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        // Toggle customer selection
        function toggleCustomerSelection(customerId) {
            if (selectedCustomers.has(customerId)) {
                selectedCustomers.delete(customerId);
            } else {
                selectedCustomers.add(customerId);
            }
            updateSelectionCount();
        }

        // Update selection count
        function updateSelectionCount() {
            const count = selectedCustomers.size;
            document.getElementById('selectedCount').textContent = `${count} selected`;
            document.getElementById('selectedCountText').textContent = count;
            
            const hasSelection = count > 0;
            document.getElementById('callSelectedBtn').disabled = !hasSelection;
            document.getElementById('updateSelectedStatusBtn').disabled = !hasSelection;
            document.getElementById('exportSelectedBtn').disabled = !hasSelection;
        }

        // Update pagination info
        function updatePaginationInfo() {
            const totalRecords = filteredCustomers.length;
            const startRecord = (currentPage - 1) * recordsPerPage + 1;
            const endRecord = Math.min(currentPage * recordsPerPage, totalRecords);
            const totalPages = Math.ceil(totalRecords / recordsPerPage);

            document.getElementById('paginationInfo').textContent = 
                `Showing ${startRecord}-${endRecord} of ${totalRecords} records`;
            document.getElementById('currentPageInfo').textContent = 
                `Page ${currentPage} of ${totalPages}`;
            
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        // Update statistics with IST timezone
        function updateStatistics() {
            const totalCustomers = customers.length;
            
            // Calculate today's uploads using IST timezone
            const istToday = new Date().toLocaleDateString('en-IN', {timeZone: 'Asia/Kolkata'});
            const todayUploads = customers.filter(c => {
                const uploadDate = new Date(c.first_uploaded_at).toLocaleDateString('en-IN', {timeZone: 'Asia/Kolkata'});
                return uploadDate === istToday;
            }).length;
            
            const statusCounts = customers.reduce((acc, customer) => {
                const status = mapCallStatus(customer.call_status || 'ready');
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            document.getElementById('totalCustomersStat').textContent = totalCustomers;
            document.getElementById('todayUploadsStat').textContent = todayUploads;
            document.getElementById('readyToCallStat').textContent = statusCounts.ready || 0;
            document.getElementById('activeCallsStat').textContent = statusCounts['in-progress'] || 0;
            document.getElementById('completedCallsStat').textContent = statusCounts.completed || 0;
            document.getElementById('totalCustomersDisplay').textContent = `Total: ${totalCustomers}`;
        }

        // Handle file upload
        async function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                showUploadProgress(true);
                logActivity(`Uploading file: ${file.name}`);

                const response = await fetch('/api/upload-customers', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    const successMessage = `Upload successful: ${result.processing_results.success_records} records processed`;
                    logActivity(`✅ ${successMessage}`);
                    showToast(successMessage, 'success');
                    
                    // Refresh customer data from database after successful upload
                    setTimeout(() => {
                        logActivity('🔄 Refreshing customer data after upload...');
                        loadCustomerData(true);
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                logActivity(`Upload failed: ${error.message}`, 'error');
                alert(`Upload failed: ${error.message}`);
            } finally {
                showUploadProgress(false);
                fileInput.value = '';
            }
        }

        // Call customer with enhanced error handling and status updates
        async function callCustomer(customerId) {
            try {
                const customer = customers.find(c => c.id === customerId);
                if (!customer) {
                    alert('Customer not found');
                    return;
                }

                logActivity(`Initiating call for ${customer.full_name} (${customer.primary_phone})`);
                
                // Disable the call button for this customer to prevent double calls
                const callBtn = document.querySelector(`button[onclick="callCustomer('${customerId}')"]`);
                if (callBtn) {
                    callBtn.disabled = true;
                    callBtn.textContent = '📞 Calling...';
                }

                const response = await fetch('/api/trigger-single-call', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ customer_id: customerId })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    logActivity(`✅ Call initiated successfully for ${customer.full_name}`);
                    // Update customer status in the UI
                    updateCustomerCallStatus(customerId, 'calling', 'Call initiated');
                    
                    // Show success toast notification
                    showToast(`Call started for ${customer.full_name}`, 'success');
                } else {
                    throw new Error(result.message || `HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Call error:', error);
                logActivity(`❌ Call failed: ${error.message}`, 'error');
                alert(`Call failed: ${error.message}`);
                
                // Re-enable the call button on error
                const callBtn = document.querySelector(`button[onclick="callCustomer('${customerId}')"]`);
                if (callBtn) {
                    callBtn.disabled = false;
                    callBtn.textContent = '📞 Call';
                }
            }
        }

        // Call selected customers with enhanced progress tracking
        async function callSelectedCustomers() {
            if (selectedCustomers.size === 0) {
                alert('Please select customers to call');
                return;
            }
            
            const customerCount = selectedCustomers.size;
            const selectedCustomerNames = Array.from(selectedCustomers).map(id => {
                const customer = customers.find(c => c.id === id);
                return customer ? customer.full_name : `ID: ${id}`;
            }).slice(0, 3).join(', ');
            
            const confirmMessage = customerCount <= 3 
                ? `Call ${customerCount} selected customers: ${selectedCustomerNames}?`
                : `Call ${customerCount} selected customers: ${selectedCustomerNames} and ${customerCount - 3} more?`;
            
            if (!confirm(confirmMessage)) return;
            
            try {
                logActivity(`🚀 Initiating bulk calls for ${customerCount} customers`);
                
                // Disable bulk call button during processing
                const bulkBtn = document.getElementById('callSelectedBtn');
                const originalText = bulkBtn.textContent;
                bulkBtn.disabled = true;
                bulkBtn.textContent = `📞 Calling ${customerCount} customers...`;

                const response = await fetch('/api/trigger-bulk-calls', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ customer_ids: Array.from(selectedCustomers) })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    logActivity(`✅ Bulk calls initiated successfully for ${customerCount} customers`);
                    
                    // Update status for all selected customers
                    selectedCustomers.forEach(customerId => {
                        updateCustomerCallStatus(customerId, 'calling', 'Bulk call initiated');
                    });
                    
                    // Show success notification
                    showToast(`Bulk calls started for ${customerCount} customers`, 'success');
                    
                    // Clear selection
                    selectedCustomers.clear();
                    updateSelectionCount();
                    document.getElementById('selectAll').checked = false;
                } else {
                    throw new Error(result.message || `HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Bulk call error:', error);
                logActivity(`❌ Bulk calls failed: ${error.message}`, 'error');
                alert(`Bulk calls failed: ${error.message}`);
            } finally {
                // Re-enable bulk call button
                const bulkBtn = document.getElementById('callSelectedBtn');
                bulkBtn.disabled = selectedCustomers.size === 0;
                bulkBtn.textContent = originalText;
            }
        }

        // Show customer details
        function showCustomerDetails(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const modalContent = document.getElementById('customerDetailsContent');
            modalContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <h4>👤 Customer Information</h4>
                        <p><strong>Name:</strong> ${customer.full_name}</p>
                        <p><strong>Phone:</strong> ${customer.primary_phone}</p>
                        <p><strong>State:</strong> ${customer.state || 'N/A'}</p>
                        <p><strong>Email:</strong> ${customer.email || 'N/A'}</p>
                        <p><strong>First Uploaded:</strong> ${formatDate(customer.first_uploaded_at)}</p>
                        <p><strong>Last Contact:</strong> ${formatDate(customer.last_contact_date) || 'Never'}</p>
                    </div>
                    <div>
                        <h4>💰 Loan Information</h4>
                        ${customer.loans.map(loan => `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 6px;">
                                <p><strong>Loan ID:</strong> ${loan.loan_id}</p>
                                <p><strong>Outstanding:</strong> ₹${formatCurrency(loan.outstanding_amount)}</p>
                                <p><strong>Due Amount:</strong> ₹${formatCurrency(loan.due_amount)}</p>
                                <p><strong>Next Due:</strong> ${formatDate(loan.next_due_date) || 'N/A'}</p>
                                <p><strong>Last Paid:</strong> ₹${formatCurrency(loan.last_paid_amount)} on ${formatDate(loan.last_paid_date) || 'N/A'}</p>
                                <p><strong>Cluster:</strong> ${loan.cluster || 'N/A'}</p>
                                <p><strong>Branch:</strong> ${loan.branch || 'N/A'}</p>
                                <p><strong>Employee:</strong> ${loan.employee_name || 'N/A'} (${loan.employee_id || 'N/A'})</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('customerModal').style.display = 'flex';
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('uploadDateFilter').value = '';
            document.getElementById('callStatusFilter').value = '';
            document.getElementById('stateFilter').value = '';
            document.getElementById('clusterFilter').value = '';
            document.getElementById('branchFilter').value = '';
            document.getElementById('employeeFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('customDateRange').style.display = 'none';
            
            applyFilters();
        }

        // Export selected customers
        function exportSelectedCustomers() {
            if (selectedCustomers.size === 0) return;
            
            const selectedData = customers.filter(c => selectedCustomers.has(c.id));
            const csvContent = convertToCSV(selectedData);
            downloadCSV(csvContent, `exported_customers_${new Date().toISOString().split('T')[0]}.csv`);
        }

        // Convert to CSV
        function convertToCSV(data) {
            const headers = [
                'Name', 'Phone', 'State', 'Loan ID', 'Outstanding Amount', 'Due Amount',
                'Next Due Date', 'Last Paid Date', 'Last Paid Amount', 'Cluster',
                'Branch', 'Branch Contact', 'Employee', 'Employee ID', 'Employee Contact',
                'Upload Date', 'Call Status'
            ];
            
            const rows = data.map(customer => {
                const loan = customer.loans[0] || {};
                return [
                    customer.full_name,
                    customer.primary_phone,
                    customer.state || '',
                    loan.loan_id || '',
                    loan.outstanding_amount || 0,
                    loan.due_amount || 0,
                    loan.next_due_date || '',
                    loan.last_paid_date || '',
                    loan.last_paid_amount || 0,
                    loan.cluster || '',
                    loan.branch || '',
                    loan.branch_contact_number || '',
                    loan.employee_name || '',
                    loan.employee_id || '',
                    loan.employee_contact_number || '',
                    customer.first_uploaded_at,
                    customer.call_status || 'ready'
                ];
            });
            
            return [headers, ...rows].map(row => 
                row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
        }

        // Download CSV
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // Utility functions
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${status}`;
            statusEl.textContent = status === 'connected' ? '🟢 Connected' : 
                                  status === 'error' ? '🔴 Error' : '🟡 Connecting...';
        }

        function showLoading(show) {
            const tbody = document.getElementById('customerTableBody');
            if (show) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="19" style="text-align: center; padding: 40px; color: #666;">
                            <div class="loading"></div>
                            <div style="margin-top: 10px;">Loading customer data...</div>
                        </td>
                    </tr>
                `;
            }
        }

        function showUploadProgress(show) {
            const progressEl = document.getElementById('uploadProgress');
            const statusEl = document.getElementById('uploadStatus');
            
            if (show) {
                progressEl.style.display = 'block';
                statusEl.innerHTML = '<div class="loading"></div> Uploading file...';
            } else {
                progressEl.style.display = 'none';
            }
        }

        function updateUploadProgress(progress, message) {
            const progressBar = document.getElementById('progressBar');
            const statusEl = document.getElementById('uploadStatus');
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
            }
            
            if (statusEl && message) {
                statusEl.textContent = message;
            }
        }

        function logActivity(message, type = 'info') {
            const timestamp = getCurrentISTTime();
            const logEntry = document.createElement('div');
            logEntry.style.cssText = `
                padding: 8px; margin: 5px 0; border-radius: 4px; font-size: 0.9em;
                background: ${type === 'error' ? '#fee' : '#f8f9fa'};
                color: ${type === 'error' ? '#c33' : '#333'};
                border-left: 3px solid ${type === 'error' ? '#dc3545' : '#667eea'};
            `;
            logEntry.innerHTML = `<strong>${timestamp} IST</strong> ${message}`;
            
            const activityLog = document.getElementById('activityLog');
            activityLog.insertBefore(logEntry, activityLog.firstChild);
            
            // Keep only last 50 entries
            while (activityLog.children.length > 50) {
                activityLog.removeChild(activityLog.lastChild);
            }
        }

        // Show toast notification
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide and remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, duration);
        }

        function setupAutoRefresh() {
            // Update status every 30 seconds
            refreshInterval = setInterval(function() {
                const refreshCount = parseInt(document.getElementById('statusRefreshCount').textContent.split(': ')[1] || '0');
                document.getElementById('statusRefreshCount').textContent = `Refreshes: ${refreshCount + 1}`;
                
                // Auto-refresh customer data every 5 minutes (300 seconds)
                if (refreshCount > 0 && refreshCount % 10 === 0) {
                    logActivity('🔄 Auto-refreshing customer data from database...');
                    loadCustomerData(false); // Silent refresh
                    
                    // Also refresh batch data every 5 minutes
                    loadBatchDetails();
                } else {
                    // Just update statistics and timestamp
                    document.getElementById('lastStatusUpdate').textContent = `Last update: ${getCurrentISTTime()} IST`;
                    updateStatistics();
                }
            }, 30000);
            
            // Initial data load
            logActivity('🚀 Starting initial data load from database...');
        }

        // Update customer call status
        function updateCustomerCallStatus(customerId, status, message) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                customer.call_status = status;
                renderCustomerTable();
                updateStatistics();
                logActivity(`Customer ${customer.full_name}: ${message || status}`);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) clearInterval(refreshInterval);
            if (ws) ws.close();
        });
    </script>
</body>
</html>
